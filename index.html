<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>땅따먹기형 런닝앱 — 안정화(SAFE) 빌드</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root { --bg:#0b0e13; --panel:rgba(255,255,255,.06); --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto}
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
    header{position:fixed;left:0;right:0;top:0;z-index:10000;padding:.75rem 1rem;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));backdrop-filter:blur(8px);display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .brand{font-weight:800}
    .chip{padding:.35rem .6rem;border-radius:999px;background:var(--panel);color:var(--muted);border:1px solid rgba(255,255,255,.12)}
    .field{display:flex;gap:.5rem;align-items:center}
    input[type="text"]{padding:.55rem .7rem;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:var(--panel);color:var(--text);min-width:120px}
    input[type="color"]{appearance:none;width:32px;height:32px;border:none;border-radius:8px;background:#0000;cursor:pointer}
    label.switch{display:inline-flex;gap:.4rem;align-items:center}
    button{appearance:none;border:1px solid rgba(255,255,255,.15);color:var(--text);background:var(--panel);padding:.6rem .85rem;border-radius:14px;cursor:pointer;font-weight:700}
    button:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.35)}
    .primary{background:linear-gradient(90deg,#22c55e22,#22d3ee22);border-color:rgba(125,211,252,.45)}
    .danger{background:linear-gradient(90deg,#f43f5e22,#fb923c22);border-color:rgba(248,113,113,.45)}
    button:disabled{opacity:.6;cursor:not-allowed;filter:grayscale(.5)}

    #topSpacer{height:72px}
    #mapWrap{position:relative;z-index:1}
    #map{height:calc(100vh - 152px)}
    #overlay{position:absolute;inset:0;pointer-events:none;z-index:1000}
    .leaflet-container{background:#0a0d12}

    .card{position:absolute;right:12px;bottom:12px;z-index:2500;min-width:260px;max-width:min(90vw,420px);background:var(--panel);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:.9rem}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.35rem .75rem;font-variant-numeric:tabular-nums}
    .stat-label{color:var(--muted);font-size:.9rem}
    .stat-value{font-size:1.1rem;font-weight:800}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:.6rem -.9rem}
    details{margin-top:.25rem}
    summary{cursor:pointer;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:.35rem .25rem;border-bottom:1px solid rgba(255,255,255,.08)}

    footer{display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;padding:.6rem 1rem;color:var(--muted)}
    .badge{display:inline-flex;gap:.35rem;align-items:center;padding:.25rem .6rem;border-radius:999px;background:var(--panel);border:1px solid rgba(255,255,255,.12)}

    #btnDiagFloat{position:fixed;top:10px;right:10px;z-index:10001;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.35);backdrop-filter:blur(6px);color:#fff;border-radius:999px;padding:.45rem .6rem;cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">🏃‍♀️ Land‑Run</div>
      <span class="chip">지도: <select id="basemap" style="background:transparent;color:var(--text);border:none"><option value="Positron" selected>Light(Positron)</option><option value="Voyager">Voyager</option><option value="OSM">OSM</option><option value="Dark">Dark</option></select></span>
      <span class="chip">GPS: <span id="gpsStatus">대기</span></span>
      <span class="chip">정확도: <span id="gpsAcc">-</span> m</span>
      <span class="chip">위치: <span id="gpsLat">-</span>, <span id="gpsLon">-</span></span>
      <button id="btnStart" class="primary" type="button">▶️ 시작</button>
      <button id="btnStop" class="danger" type="button" disabled>⏹️ 종료</button>
      <button id="btnReset" type="button">🧹 초기화</button>
      <div class="field"><span class="chip">닉</span><input id="nickname" type="text" placeholder="Runner" /></div>
      <div class="field"><span class="chip">색상</span><input id="color" type="color" value="#22c55e" /></div>
      <label class="switch"><input id="debugMode" type="checkbox"><strong>디버그</strong>(←↑→↓)</label>
      <button id="btnDiag" title="진단" type="button">🩺</button>
    </header>
    <div id="topSpacer"></div>
    <button id="btnDiagFloat" type="button" title="진단">🩺</button>

    <div id="mapWrap">
      <div id="map"></div>
      <canvas id="overlay"></canvas>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem"><strong>📊 통계</strong><span class="badge">그리드: 1 m²</span></div>
        <div class="stats">
          <div class="stat-label">시간</div><div class="stat-value" id="statTime">00:00</div>
          <div class="stat-label">블록</div><div class="stat-value" id="statCells">0</div>
          <div class="stat-label">거리</div><div class="stat-value" id="statDist">0.00 km</div>
        </div>
        <div class="hr"></div>
        <details>
          <summary>📈 로컬 리더보드</summary>
          <div id="leaderboard" style="margin-top:.4rem"></div>
        </details>
        <details id="diag" style="margin-top:.4rem;display:none">
          <summary>🩺 진단 로그</summary>
          <pre id="log" style="max-height:180px;overflow:auto;white-space:pre-wrap"></pre>
        </details>
      </div>
    </div>

    <footer>
      <div>※ HTTPS 권장. 위치 권한 허용 시 지도 위에 1m² 칠해집니다.</div>
      <div class="right">
        <a class="badge" id="btnExport" href="#" download="run.geojson">📥 경로(GEOJSON)</a>
        <button id="btnClearAll" class="badge" type="button">🗑️ 기록 삭제</button>
      </div>
    </footer>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', ()=>{
    // -------- Diagnostics --------
    const logEl = document.getElementById('log');
    const diagBox = document.getElementById('diag');
    function log(line){ const t = new Date().toISOString().slice(11,19); const s = `[landrun] ${t} | ${line}
`; console.log(s); if(logEl){ logEl.textContent += s; logEl.scrollTop = logEl.scrollHeight; } }
    window.addEventListener('error', (e)=>{ log('window error: '+e.message); });
    window.addEventListener('unhandledrejection', (e)=>{ log('promise rejection: '+(e.reason && e.reason.message ? e.reason.message : e.reason)); });

    // -------- Helpers --------
    const R=6378137, toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
    const lonLatToMeters=(lon,lat)=>({x:R*toRad(lon), y:R*Math.log(Math.tan(Math.PI/4+toRad(lat)/2))});
    const metersToLonLat=(x,y)=>({lon:toDeg(x/R), lat:toDeg(2*Math.atan(Math.exp(y/R))-Math.PI/2)});
    const haversine=(a,b,c,d)=>{const dLat=toRad(c-a), dLon=toRad(d-b); const A=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(A));}
    const hexToRgba=(hex,a=1)=>{ let c=hex.replace('#',''); if(c.length===3)c=c.split('').map(ch=>ch+ch).join(''); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

    // -------- Map --------
    const map = L.map('map',{zoomControl:false,minZoom:10,maxZoom:20,preferCanvas:true}).setView([37.5665,126.9780],18);
    L.control.zoom({position:'bottomleft'}).addTo(map);
    const baseLayers={
      Positron:L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap, &copy; CARTO'}),
      Voyager:L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap, &copy; CARTO'}),
      OSM:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}),
      Dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap, &copy; CARTO'})
    };
    let currentBase=baseLayers.Positron.addTo(map);

    // -------- Overlay Canvas --------
    const overlay=document.getElementById('overlay'); const octx=overlay.getContext('2d');
    function syncOverlay(){ const r=document.getElementById('map').getBoundingClientRect(); const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1)); overlay.width=Math.floor(r.width*dpr); overlay.height=Math.floor(r.height*dpr); overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px'; octx.setTransform(dpr,0,0,dpr,0,0); scheduleDraw(); log('overlay synced'); }
    window.addEventListener('resize', syncOverlay); map.on('resize', syncOverlay);

    let rafPending=false; function scheduleDraw(){ if(rafPending) return; rafPending=true; requestAnimationFrame(()=>{ rafPending=false; drawCells(); }); }

    // -------- State --------
    const gpsStatusEl=document.getElementById('gpsStatus'), gpsAccEl=document.getElementById('gpsAcc'), gpsLatEl=document.getElementById('gpsLat'), gpsLonEl=document.getElementById('gpsLon');
    const statTimeEl=document.getElementById('statTime'), statCellsEl=document.getElementById('statCells'), statDistEl=document.getElementById('statDist');
    const btnStart=document.getElementById('btnStart'), btnStop=document.getElementById('btnStop'), btnReset=document.getElementById('btnReset'), btnClearAll=document.getElementById('btnClearAll'), btnExport=document.getElementById('btnExport');
    const btnDiag=document.getElementById('btnDiag'), btnDiagFloat=document.getElementById('btnDiagFloat');
    const baseSel=document.getElementById('basemap');
    const colorInput=document.getElementById('color'); const nicknameInput=document.getElementById('nickname'); const debugMode=document.getElementById('debugMode');

    let running=false, watchId=null, startTime=null, timerId=null; let lastPos=null, totalDistance=0; let path=[];

    // Multi-user LWW owners
    const cellOwners=new Map(); // key "ix,iy" -> {nick,color,t}
    const currentNick=()=>nicknameInput.value||'Runner';

    function setCellOwner(ix,iy,nick,color){ cellOwners.set(`${ix},${iy}`,{nick,color,t:Date.now()}); }

    // Continuous paint via grid traversal
    function rasterizeSegment(lat1,lon1,lat2,lon2){
      const a=lonLatToMeters(lon1,lat1), b=lonLatToMeters(lon2,lat2);
      let x0=a.x, y0=a.y, x1=b.x, y1=b.y;
      let ix=Math.floor(x0), iy=Math.floor(y0), endX=Math.floor(x1), endY=Math.floor(y1);
      setCellOwner(ix,iy,currentNick(),colorInput.value);
      if(ix===endX && iy===endY) return;
      const dx=x1-x0, dy=y1-y0; const stepX=dx>0?1:(dx<0?-1:0), stepY=dy>0?1:(dy<0?-1:0);
      const invDx=dx!==0?1/dx:0, invDy=dy!==0?1/dy:0;
      let tMaxX= stepX>0? ( (ix+1 - x0)*invDx ) : (stepX<0? ((x0 - ix)*-invDx) : Infinity);
      let tMaxY= stepY>0? ( (iy+1 - y0)*invDy ) : (stepY<0? ((y0 - iy)*-invDy) : Infinity);
      const tDeltaX= stepX!==0? Math.abs(invDx) : Infinity;
      const tDeltaY= stepY!==0? Math.abs(invDy) : Infinity;
      let guard=0; while((ix!==endX || iy!==endY) && guard++<20000){
        if(tMaxX < tMaxY){ ix+=stepX; tMaxX+=tDeltaX; } else { iy+=stepY; tMaxY+=tDeltaY; }
        setCellOwner(ix,iy,currentNick(),colorInput.value);
      }
    }

    function addPosition(lat,lon,acc){ try{
      if(lastPos){ totalDistance+=haversine(lastPos.lat,lastPos.lon,lat,lon); rasterizeSegment(lastPos.lat,lastPos.lon,lat,lon); }
      else { const m=lonLatToMeters(lon,lat); setCellOwner(Math.floor(m.x),Math.floor(m.y),currentNick(),colorInput.value); }
      lastPos={lat,lon}; path.push({lat,lon,t:Date.now()});
      gpsAccEl.textContent=acc?acc.toFixed(1):'-'; gpsLatEl.textContent=lat.toFixed(6); gpsLonEl.textContent=lon.toFixed(6);
      statCellsEl.textContent=ownedCountBy(currentNick()).toLocaleString(); statDistEl.textContent=(totalDistance/1000).toFixed(2)+' km';
      map.setView([lat,lon], map.getZoom(), {animate:false});
      scheduleDraw(); prepareExport();
    }catch(e){ log('addPosition error: '+e); }}

    function ownedCountBy(nick){ let c=0; for(const v of cellOwners.values()){ if(v.nick===nick) c++; } return c; }

    function drawCells(){ try{
      const {x:W,y:H}=map.getSize(); octx.clearRect(0,0,W,H);
      if(cellOwners.size===0) return;
      const b=map.getBounds(); const nwM=lonLatToMeters(b.getWest(),b.getNorth()), seM=lonLatToMeters(b.getEast(),b.getSouth());
      const minX=Math.min(nwM.x,seM.x), maxX=Math.max(nwM.x,seM.x), minY=Math.min(seM.y,nwM.y), maxY=Math.max(seM.y,nwM.y);
      const MIN_PX=0.75;
      for(const [k,owner] of cellOwners){ const [ixS,iyS]=k.split(','); const ix=+ixS, iy=+iyS; if(ix<Math.floor(minX)-1||ix>Math.ceil(maxX)+1||iy<Math.floor(minY)-1||iy>Math.ceil(maxY)+1) continue; const ll=metersToLonLat(ix,iy), ur=metersToLonLat(ix+1,iy+1); const pA=map.latLngToContainerPoint([ll.lat,ll.lon]), pB=map.latLngToContainerPoint([ur.lat,ur.lon]); let x=Math.min(pA.x,pB.x), y=Math.min(pA.y,pB.y), w=Math.abs(pB.x-pA.x), h=Math.abs(pB.y-pA.y); x=Math.round(x); y=Math.round(y); w=Math.max(MIN_PX,Math.round(w)); h=Math.max(MIN_PX,Math.round(h)); octx.fillStyle=hexToRgba(owner.color,0.9); octx.fillRect(x,y,w,h); }
      // also draw a thin polyline for far zoom legibility
      if(path.length>1){ octx.beginPath(); const start=Math.max(0,path.length-1000); for(let i=start;i<path.length;i++){ const p=map.latLngToContainerPoint([path[i].lat,path[i].lon]); if(i===start)octx.moveTo(p.x,p.y); else octx.lineTo(p.x,p.y); } octx.lineWidth=2; octx.strokeStyle=colorInput.value; octx.stroke(); }
      if(lastPos){ const p=map.latLngToContainerPoint([lastPos.lat,lastPos.lon]); octx.beginPath(); octx.arc(Math.round(p.x),Math.round(p.y),4,0,Math.PI*2); octx.fillStyle='#fff'; octx.fill(); octx.lineWidth=2; octx.strokeStyle=colorInput.value; octx.stroke(); }
    }catch(e){ log('drawCells error: '+e); }}

    function updateTimer(){ if(!running||!startTime) return; const sec=Math.floor((Date.now()-startTime)/1000); const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); statTimeEl.textContent=`${m}:${s}`; }

    function startWatch(){ if(!('geolocation' in navigator)){ alert('이 기기에서는 위치 서비스를 사용할 수 없습니다. 디버그 모드(←↑→↓)로 테스트하세요.'); log('geolocation not available'); return; } gpsStatusEl.textContent='요청 중…'; watchId=navigator.geolocation.watchPosition(pos=>{ gpsStatusEl.textContent='수신'; const {latitude:lat,longitude:lon,accuracy}=pos.coords; addPosition(lat,lon,accuracy); }, err=>{ gpsStatusEl.textContent='오류'; log('geolocation error: '+JSON.stringify({code:err.code,message:err.message})); if(err.code===1) alert('위치 권한을 허용해주세요.'); }, {enableHighAccuracy:true,maximumAge:1000,timeout:10000}); }
    function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } gpsStatusEl.textContent='중지'; }

    function startRun(){ if(running) return; running=true; btnStart.disabled=true; btnStop.disabled=false; startTime=Date.now(); timerId=setInterval(updateTimer,250); path=[]; totalDistance=0; lastPos=null; scheduleDraw(); map.dragging.disable(); map.scrollWheelZoom.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); startWatch(); log('run start'); }
    function stopRun(save=true){ if(!running) return; running=false; btnStart.disabled=false; btnStop.disabled=true; clearInterval(timerId); timerId=null; updateTimer(); stopWatch(); if(save) persistRun(); updateLeaderboard(); prepareExport(); map.dragging.enable(); map.scrollWheelZoom.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable(); log('run stop'); }
    function resetSession(){ stopRun(false); lastPos=null; path=[]; totalDistance=0; startTime=null; statTimeEl.textContent='00:00'; statCellsEl.textContent='0'; statDistEl.textContent='0.00 km'; scheduleDraw(); log('session reset'); }

    // Debug keyboard
    let fake={lat:37.5665,lon:126.9780};
    document.addEventListener('keydown', (e)=>{ try{ if(!debugMode.checked) return; const step=(e.shiftKey?0.00025:0.00012); if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault(); if(e.key==='ArrowUp') fake.lat+=step; else if(e.key==='ArrowDown') fake.lat-=step; else if(e.key==='Left'||e.key==='ArrowLeft') fake.lon-=step; else if(e.key==='Right'||e.key==='ArrowRight') fake.lon+=step; else return; addPosition(fake.lat,fake.lon,null);}catch(err){log('debug key error: '+err)}});

    // Basemap switch
    baseSel.addEventListener('change', ()=>{ try{ if(currentBase) map.removeLayer(currentBase); currentBase=baseLayers[baseSel.value]; currentBase.addTo(map); log('basemap -> '+baseSel.value); scheduleDraw(); }catch(e){ log('basemap error: '+e); } });

    // Leaderboard & storage
    const STORAGE_KEY='landrun.runs.safe'; const loadRuns=()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}}; const saveRuns=a=>localStorage.setItem(STORAGE_KEY,JSON.stringify(a));
    function persistRun(){ const runs=loadRuns(); const secs=startTime?Math.floor((Date.now()-startTime)/1000):0; runs.push({t:Date.now(),nick:currentNick(),color:colorInput.value,seconds:secs,cells:ownedCountBy(currentNick()),km:+(totalDistance/1000).toFixed(3)}); saveRuns(runs); }
    function updateLeaderboard(){ const runs=loadRuns(); const fmt=s=>`${Math.floor(s/60)}m ${s%60}s`; const byCells=[...runs].sort((a,b)=>b.cells-a.cells).slice(0,5); const byTime=[...runs].sort((a,b)=>b.seconds-a.seconds).slice(0,5); document.getElementById('leaderboard').innerHTML = runs.length?`<div style="margin-bottom:.25rem"><strong>최다 블록 Top 5</strong></div><table><thead><tr><th>#</th><th>닉</th><th>블록</th><th>시간</th><th>km</th></tr></thead><tbody>${byCells.map((r,i)=>`<tr><td>${i+1}</td><td>${r.nick}</td><td>${r.cells.toLocaleString()}</td><td>${fmt(r.seconds)}</td><td>${r.km}</td></tr>`).join('')}</tbody></table><div style="height:.5rem"></div><div style="margin-bottom:.25rem"><strong>최장 시간 Top 5</strong></div><table><thead><tr><th>#</th><th>닉</th><th>시간</th><th>블록</th><th>km</th></tr></thead><tbody>${byTime.map((r,i)=>`<tr><td>${i+1}</td><td>${r.nick}</td><td>${fmt(r.seconds)}</td><td>${r.cells.toLocaleString()}</td><td>${r.km}</td></tr>`).join('')}</tbody></table>`:'<span class="muted">기록이 없습니다.</span>'; }

    btnClearAll.addEventListener('click',()=>{ if(confirm('기기 내 모든 기록을 삭제할까요?')){ localStorage.removeItem(STORAGE_KEY); updateLeaderboard(); log('cleared all'); }});

    // Export
    function prepareExport(){ if(path.length<2){ btnExport.href='#'; return; } const geojson={type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:path.map(p=>[p.lon,p.lat])},properties:{nickname:currentNick(),color:colorInput.value,cells:ownedCountBy(currentNick()),km:+(totalDistance/1000).toFixed(3)}}]}; const blob=new Blob([JSON.stringify(geojson,null,2)],{type:'application/geo+json'}); const url=URL.createObjectURL(blob); btnExport.href=url; }

    // Buttons
    function toggleDiag(){ const s=diagBox.style.display==='none'; diagBox.style.display=s?'block':'none'; log('diag '+(s?'open':'close')); }
    btnDiag.addEventListener('click', ()=>{ log('btnDiag click'); toggleDiag(); });
    btnDiagFloat.addEventListener('click', ()=>{ log('btnDiagFloat click'); toggleDiag(); });
    btnStart.addEventListener('click', ()=>{ log('btnStart click'); startRun(); });
    btnStop.addEventListener('click', ()=>{ log('btnStop click'); stopRun(true); });
    btnReset.addEventListener('click', ()=>{ log('btnReset click'); resetSession(); });

    // Map movement triggers redraw
    map.on('move moveend zoom zoomend viewreset', scheduleDraw);

    // Init
    syncOverlay(); updateLeaderboard(); log('ready');
  });
  </script>
</body>
</html>
