<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë•…ë”°ë¨¹ê¸°í˜• ëŸ°ë‹ì•± (ì§€ë„ ì—°ë™ í”„ë¡œí† íƒ€ì…)</title>
  <!-- Leaflet (ì§€ë„) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root {
      --bg: #0b0e13;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.10);
      --accent: #7dd3fc;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --good: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji}

    /* Layout */
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
    header{
      position:sticky;top:0;z-index:1000;
      padding:.75rem 1rem;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));
      backdrop-filter: blur(8px);
      display:grid;gap:.5rem;grid-template-columns:1fr auto;align-items:center
    }
    .left, .right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .brand{font-weight:800;letter-spacing:.2px}
    .chip{padding:.35rem .6rem;border-radius:999px;background:var(--panel);color:var(--muted);border:1px solid rgba(255,255,255,.12)}
    .field{display:flex;gap:.5rem;align-items:center}
    input[type="text"]{padding:.55rem .7rem;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:var(--panel);color:var(--text);min-width:140px}
    input[type="color"]{appearance:none;width:32px;height:32px;border:none;border-radius:8px;background:#0000;overflow:hidden;cursor:pointer}
    .switch{display:inline-flex;gap:.45rem;align-items:center}

    button{appearance:none;border:1px solid rgba(255,255,255,.15);color:var(--text);background:var(--panel);padding:.65rem .95rem;border-radius:14px;cursor:pointer;transition:.2s transform,.2s background,.2s border-color;font-weight:700}
    button:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.35)}
    .primary{background:linear-gradient(90deg,#22d3ee22,#22c55e22);border-color:rgba(125,211,252,.45)}
    .danger{background:linear-gradient(90deg,#f43f5e22,#fb923c22);border-color:rgba(248,113,113,.45)}
    button:disabled{opacity:.6;cursor:not-allowed;filter:grayscale(.5)}

    /* Map */
    #mapWrap{position:relative}
    #map{height:calc(100vh - 152px)}
    #overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    .leaflet-container{background:#0a0d12}

    /* Stats Card (floating) */
    .card{
      position:absolute;right:12px;bottom:12px;z-index:1200;min-width:260px;max-width:min(90vw,420px);
      background:var(--panel);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:.9rem;box-shadow:0 10px 30px rgba(0,0,0,.4)
    }
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.35rem .75rem;align-items:center;font-variant-numeric:tabular-nums}
    .stat-label{color:var(--muted);font-size:.9rem}
    .stat-value{font-size:1.1rem;font-weight:800}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:.6rem -.9rem}
    details{margin-top:.25rem}
    summary{cursor:pointer;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:.35rem .25rem;border-bottom:1px solid rgba(255,255,255,.08)}

    footer{display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;padding:.6rem 1rem;color:var(--muted)}
    .badge{display:inline-flex;gap:.35rem;align-items:center;padding:.25rem .6rem;border-radius:999px;background:var(--panel);border:1px solid rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <div class="app">
    <!-- Top Bar / Controls (inspired by running apps) -->
    <header>
      <div class="left">
        <div class="brand">ğŸƒâ€â™€ï¸ Landâ€‘Run</div>
        <span class="chip">GPS: <span id="gpsStatus">ëŒ€ê¸°</span></span>
        <span class="chip">ì •í™•ë„: <span id="gpsAcc">-</span> m</span>
        <span class="chip">ìœ„ì¹˜: <span id="gpsLat">-</span>, <span id="gpsLon">-</span></span>
      </div>
      <div class="right">
        <button id="btnStart" class="primary">â–¶ï¸ ëŸ¬ë‹ ì‹œì‘</button>
        <button id="btnStop" class="danger" disabled>â¹ï¸ ì¢…ë£Œ</button>
        <button id="btnReset">ğŸ§¹ ì„¸ì…˜ ì´ˆê¸°í™”</button>
        <div class="field"><span class="chip">ë‹‰</span><input id="nickname" type="text" placeholder="Runner" /></div>
        <div class="field"><span class="chip">ìƒ‰ìƒ</span><input id="color" type="color" value="#22c55e" /></div>
        <label class="switch"><input id="debugMode" type="checkbox">ë””ë²„ê·¸(â†â†‘â†’â†“)</label>
      </div>
    </header>

    <!-- Map + Overlay -->
    <div id="mapWrap">
      <div id="map"></div>
      <canvas id="overlay"></canvas>

      <!-- Floating stats card -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem">
          <strong>ğŸ“Š ì„¸ì…˜ í†µê³„</strong>
          <span class="badge">ê·¸ë¦¬ë“œ: 1 mÂ²</span>
        </div>
        <div class="stats">
          <div class="stat-label">ì‹œê°„</div><div class="stat-value" id="statTime">00:00</div>
          <div class="stat-label">ë¸”ë¡</div><div class="stat-value" id="statCells">0</div>
          <div class="stat-label">ê±°ë¦¬</div><div class="stat-value" id="statDist">0.00 km</div>
        </div>
        <div class="hr"></div>
        <details>
          <summary>ğŸ“ˆ ë¡œì»¬ ë¦¬ë”ë³´ë“œ</summary>
          <div id="leaderboard" style="margin-top:.4rem"></div>
        </details>
      </div>
    </div>

    <footer>
      <div>â€» OSM íƒ€ì¼ì´ ë¡œë“œë˜ëŠ” ì˜¨ë¼ì¸ í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ì‹¤ì œ ì§€ë„ ìœ„ì— 1 mÂ² ê·¸ë¦¬ë“œë¥¼ ì¹ í•©ë‹ˆë‹¤.</div>
      <div class="right">
        <a class="badge" id="btnExport" href="#" download="run.geojson">ğŸ“¥ ê²½ë¡œ(GEOJSON)</a>
        <button id="btnClearAll" class="badge">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
      </div>
    </footer>
  </div>

  <script>
    // ---------- Geo & Projection Helpers ----------
    const R = 6378137; // meters (WGS84)
    const toRad = d=>d*Math.PI/180;
    const toDeg = r=>r*180/Math.PI;
    // Spherical Mercator <-> lon/lat
    const lonLatToMeters = (lon,lat)=>({
      x: R*toRad(lon),
      y: R*Math.log(Math.tan(Math.PI/4 + toRad(lat)/2))
    });
    const metersToLonLat = (x,y)=>({
      lon: toDeg(x/R),
      lat: toDeg(2*Math.atan(Math.exp(y/R))-Math.PI/2)
    });
    function haversine(lat1,lon1,lat2,lon2){
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    // ---------- Leaflet Map ----------
    const map = L.map('map', {
      zoomControl: false, // ì»¤ìŠ¤í…€ UI ëŠë‚Œ
      minZoom: 10,
      maxZoom: 20,
      preferCanvas: true
    }).setView([37.5665,126.9780], 18); // ì„œìš¸ì‹œì²­ ê·¼ì²˜

    L.control.zoom({ position: 'bottomleft' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Canvas overlay to paint visited 1mÂ² cells
    const overlay = document.getElementById('overlay');
    const octx = overlay.getContext('2d');
    function syncOverlaySize(){
      const r = document.getElementById('map').getBoundingClientRect();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      overlay.width = Math.floor(r.width * dpr);
      overlay.height = Math.floor(r.height * dpr);
      overlay.style.width = r.width + 'px';
      overlay.style.height = r.height + 'px';
      octx.setTransform(dpr,0,0,dpr,0,0);
      drawCells();
    }
    window.addEventListener('resize', syncOverlaySize);
    map.on('zoomend moveend', drawCells);

    // ---------- App State ----------
    const gpsStatusEl = document.getElementById('gpsStatus');
    const gpsAccEl = document.getElementById('gpsAcc');
    const gpsLatEl = document.getElementById('gpsLat');
    const gpsLonEl = document.getElementById('gpsLon');
    const statTimeEl = document.getElementById('statTime');
    const statCellsEl = document.getElementById('statCells');
    const statDistEl = document.getElementById('statDist');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnReset = document.getElementById('btnReset');
    const btnClearAll = document.getElementById('btnClearAll');
    const btnExport = document.getElementById('btnExport');
    const colorInput = document.getElementById('color');
    const nicknameInput = document.getElementById('nickname');
    const debugMode = document.getElementById('debugMode');
    const leaderboardEl = document.getElementById('leaderboard');

    let running=false, watchId=null, startTime=null, timerId=null;
    let lastPos=null, totalDistance=0;
    let path=[]; // [{lat,lon,t}]
    let visited=new Set(); // keys: "ix,iy" (1m grid in Mercator meters)

    function key(ix,iy){ return `${ix},${iy}` }

    function addPosition(lat,lon,acc){
      if(lastPos){ totalDistance += haversine(lastPos.lat,lastPos.lon,lat,lon); }
      lastPos = {lat,lon};
      path.push({lat,lon,t:Date.now()});
      const m = lonLatToMeters(lon,lat);
      const ix = Math.floor(m.x), iy = Math.floor(m.y);
      visited.add(key(ix,iy));
      gpsAccEl.textContent = acc? acc.toFixed(1) : '-';
      gpsLatEl.textContent = lat.toFixed(6);
      gpsLonEl.textContent = lon.toFixed(6);
      statCellsEl.textContent = visited.size.toLocaleString();
      statDistEl.textContent = (totalDistance/1000).toFixed(2) + ' km';
      map.panTo([lat,lon], { animate: false });
      drawCells();
      prepareExport();
    }

    // Draw visited cells on overlay canvas aligned with Leaflet container pixels
    function drawCells(){
      const userColor = colorInput.value;
      const mapDiv = document.getElementById('map');
      const {width, height} = mapDiv.getBoundingClientRect();
      octx.clearRect(0,0,width,height);
      if(!lastPos) return;
      // Calculate viewport bounds in meters to cull
      const b = map.getBounds();
      const nwM = lonLatToMeters(b.getWest(), b.getNorth());
      const seM = lonLatToMeters(b.getEast(), b.getSouth());
      const minX = Math.min(nwM.x, seM.x), maxX = Math.max(nwM.x, seM.x);
      const minY = Math.min(seM.y, nwM.y), maxY = Math.max(seM.y, nwM.y);

      octx.fillStyle = userColor + 'cc';
      octx.strokeStyle = userColor;
      // Iterate visited cells and draw rects that are within bounds
      for(const k of visited){
        const [ixStr, iyStr] = k.split(',');
        const ix = parseInt(ixStr,10), iy = parseInt(iyStr,10);
        if(ix < Math.floor(minX)-1 || ix > Math.ceil(maxX)+1 || iy < Math.floor(minY)-1 || iy > Math.ceil(maxY)+1) continue;
        // project cell corners back to lat/lng then to container points
        const p1 = metersToLonLat(ix, iy);
        const p2 = metersToLonLat(ix+1, iy+1);
        const tl = map.latLngToContainerPoint([p1.lat, p1.lon]);
        const br = map.latLngToContainerPoint([p2.lat, p2.lon]);
        const w = br.x - tl.x, h = br.y - tl.y; // y grows downward in screen coords
        // skip if too small to see
        if(w<0.5 || h<0.5) continue;
        octx.fillRect(Math.floor(tl.x), Math.floor(tl.y), Math.ceil(w), Math.ceil(h));
      }

      // Draw current location dot
      if(lastPos){
        const p = map.latLngToContainerPoint([lastPos.lat,lastPos.lon]);
        octx.beginPath();
        octx.arc(p.x, p.y, 4, 0, Math.PI*2);
        octx.fillStyle = '#fff';
        octx.fill();
        octx.lineWidth = 2; octx.strokeStyle = userColor; octx.stroke();
      }
    }

    function updateTimer(){
      if(!running || !startTime) return;
      const sec = Math.floor((Date.now()-startTime)/1000);
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      statTimeEl.textContent = `${m}:${s}`;
    }

    // ---------- Geolocation ----------
    function startWatch(){
      if(!('geolocation' in navigator)){
        alert('ì´ ê¸°ê¸°ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë””ë²„ê·¸ ëª¨ë“œ(í‚¤ë³´ë“œ)ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.');
        return;
      }
      gpsStatusEl.textContent = 'ìš”ì²­ ì¤‘â€¦';
      watchId = navigator.geolocation.watchPosition(pos=>{
        gpsStatusEl.textContent = 'ìˆ˜ì‹ ';
        const {latitude:lat, longitude:lon, accuracy} = pos.coords;
        addPosition(lat,lon,accuracy);
      }, err=>{
        gpsStatusEl.textContent = 'ì˜¤ë¥˜';
        console.warn(err);
        if(err.code===1) alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
      }, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    }
    function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } gpsStatusEl.textContent = 'ì¤‘ì§€'; }

    // ---------- Controls ----------
    function startRun(){
      if(running) return;
      running=true; btnStart.disabled=true; btnStop.disabled=false;
      startTime = Date.now(); timerId=setInterval(updateTimer,250);
      path=[]; visited=new Set(); totalDistance=0; lastPos=null;
      drawCells();
      startWatch();
    }
    function stopRun(save=true){
      if(!running) return;
      running=false; btnStart.disabled=false; btnStop.disabled=true;
      clearInterval(timerId); timerId=null; updateTimer();
      stopWatch();
      if(save) persistRun();
      updateLeaderboard();
      prepareExport();
    }
    function resetSession(){
      stopRun(false);
      lastPos=null; path=[]; visited=new Set(); totalDistance=0; startTime=null;
      statTimeEl.textContent='00:00'; statCellsEl.textContent='0'; statDistEl.textContent='0.00 km';
      drawCells();
    }

    // ---------- Debug Movement ----------
    let fake = {lat:37.5665, lon:126.9780};
    window.addEventListener('keydown', e=>{
      if(!debugMode.checked) return;
      const step = (e.shiftKey? 0.0002 : 0.00008);
      if(e.key==='ArrowUp') fake.lat += step;
      else if(e.key==='ArrowDown') fake.lat -= step;
      else if(e.key==='ArrowLeft') fake.lon -= step;
      else if(e.key==='ArrowRight') fake.lon += step;
      else return;
      e.preventDefault();
      addPosition(fake.lat,fake.lon,null);
    });

    // ---------- Persistence & Leaderboard ----------
    const STORAGE_KEY='landrun.runs.v2';
    const loadRuns=()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}};
    const saveRuns=arr=>localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));
    function persistRun(){
      const runs=loadRuns();
      const secs=startTime?Math.floor((Date.now()-startTime)/1000):0;
      const nick=(nicknameInput.value||'Runner');
      runs.push({t:Date.now(),nick,color:colorInput.value,seconds:secs,cells:visited.size,km:+(totalDistance/1000).toFixed(3)});
      saveRuns(runs);
    }
    function updateLeaderboard(){
      const runs=loadRuns();
      const fmtTime=s=>`${Math.floor(s/60)}m ${s%60}s`;
      const byCells=[...runs].sort((a,b)=>b.cells-a.cells).slice(0,5);
      const byTime=[...runs].sort((a,b)=>b.seconds-a.seconds).slice(0,5);
      leaderboardEl.innerHTML = `
        <div style="margin-bottom:.25rem"><strong>ìµœë‹¤ ë¸”ë¡ Top 5</strong></div>
        <table><thead><tr><th>#</th><th>ë‹‰</th><th>ë¸”ë¡</th><th>ì‹œê°„</th><th>km</th></tr></thead>
        <tbody>${byCells.map((r,i)=>`<tr><td>${i+1}</td><td>${r.nick}</td><td>${r.cells.toLocaleString()}</td><td>${fmtTime(r.seconds)}</td><td>${r.km}</td></tr>`).join('')}</tbody></table>
        <div style="height:.5rem"></div>
        <div style="margin-bottom:.25rem"><strong>ìµœì¥ ì‹œê°„ Top 5</strong></div>
        <table><thead><tr><th>#</th><th>ë‹‰</th><th>ì‹œê°„</th><th>ë¸”ë¡</th><th>km</th></tr></thead>
        <tbody>${byTime.map((r,i)=>`<tr><td>${i+1}</td><td>${r.nick}</td><td>${fmtTime(r.seconds)}</td><td>${r.cells.toLocaleString()}</td><td>${r.km}</td></tr>`).join('')}</tbody></table>`;
    }

    btnClearAll.addEventListener('click',()=>{if(confirm('ê¸°ê¸° ë‚´ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')){localStorage.removeItem(STORAGE_KEY);updateLeaderboard();}});

    // ---------- Export GEOJSON ----------
    function prepareExport(){
      if(path.length<2){ btnExport.href='#'; return; }
      const geojson={type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:path.map(p=>[p.lon,p.lat])},properties:{nickname:nicknameInput.value||'Runner',color:colorInput.value,cells:visited.size,km:+(totalDistance/1000).toFixed(3)}}]};
      const blob=new Blob([JSON.stringify(geojson,null,2)],{type:'application/geo+json'});
      const url=URL.createObjectURL(blob);
      btnExport.href=url;
    }

    // ---------- Wire UI ----------
    btnStart.addEventListener('click', startRun);
    btnStop.addEventListener('click', ()=>stopRun(true));
    btnReset.addEventListener('click', resetSession);

    // Init
    syncOverlaySize();
    updateLeaderboard();
  </script>
</body>
</html>
